name: ðŸ¤– æ™ºèƒ½å›¾ç‰‡åº“è‡ªåŠ¨åŒæ­¥

on:
  # å½“ uploads ç›®å½•æœ‰ä»»ä½•å˜åŒ–æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'public/uploads/**'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºå…ƒæ•°æ®'
        required: false
        default: 'false'
        type: boolean
  
  # å®šæ—¶æ£€æŸ¥ï¼ˆæ¯30åˆ†é’Ÿï¼‰
  schedule:
    - cron: '*/30 * * * *'

# æƒé™è®¾ç½®
permissions:
  contents: write
  pages: write
  id-token: write

# ç¡®ä¿åªæœ‰ä¸€ä¸ªå·¥ä½œæµå®žä¾‹è¿è¡Œ
concurrency:
  group: gallery-sync
  cancel-in-progress: false

jobs:
  auto-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ”§ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: ðŸ” æ™ºèƒ½æ‰«æå›¾ç‰‡
      id: scan
      run: |
        echo "ðŸ” å¼€å§‹æ™ºèƒ½æ‰«æå›¾ç‰‡ç›®å½•..."
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p public/uploads/$(date +%Y)/$(date +%m)
        
        # æ‰«ææ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
        IMAGES=$(find public/uploads -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" -o -iname "*.JPG" -o -iname "*.JPEG" -o -iname "*.PNG" \) 2>/dev/null | sort)
        IMAGE_COUNT=$(echo "$IMAGES" | grep -c . || echo "0")
        
        echo "ðŸ“Š å‘çŽ°å›¾ç‰‡æ€»æ•°: $IMAGE_COUNT"
        echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å›¾ç‰‡ï¼ˆä¸ŽçŽ°æœ‰å…ƒæ•°æ®å¯¹æ¯”ï¼‰
        if [ -f "public/gallery-metadata.json" ]; then
          CURRENT_COUNT=$(node -e "try { console.log(JSON.parse(require('fs').readFileSync('public/gallery-metadata.json', 'utf8')).count); } catch(e) { console.log('0'); }")
          echo "ðŸ“‹ å½“å‰å…ƒæ•°æ®è®°å½•: $CURRENT_COUNT å¼ å›¾ç‰‡"
          
          if [ "$IMAGE_COUNT" != "$CURRENT_COUNT" ]; then
            echo "ðŸ†• æ£€æµ‹åˆ°å›¾ç‰‡æ•°é‡å˜åŒ–: $CURRENT_COUNT â†’ $IMAGE_COUNT"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "count_change=$((IMAGE_COUNT - CURRENT_COUNT))" >> $GITHUB_OUTPUT
          else
            echo "âœ… å›¾ç‰‡æ•°é‡æ— å˜åŒ–"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "ðŸ†• é¦–æ¬¡ç”Ÿæˆå…ƒæ•°æ®"
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "count_change=$IMAGE_COUNT" >> $GITHUB_OUTPUT
        fi
        
        # èŽ·å–æœ€æ–°å›¾ç‰‡ä¿¡æ¯
        if [ $IMAGE_COUNT -gt 0 ]; then
          LATEST_IMAGE=$(echo "$IMAGES" | head -1)
          LATEST_NAME=$(basename "$LATEST_IMAGE")
          LATEST_SIZE=$(stat -f%z "$LATEST_IMAGE" 2>/dev/null || stat -c%s "$LATEST_IMAGE" 2>/dev/null || echo "0")
          echo "latest_image=$LATEST_NAME" >> $GITHUB_OUTPUT
          echo "latest_size=$LATEST_SIZE" >> $GITHUB_OUTPUT
          echo "ðŸ“¸ æœ€æ–°å›¾ç‰‡: $LATEST_NAME (${LATEST_SIZE} bytes)"
        fi
    
    - name: ðŸ“Š ç”Ÿæˆå…ƒæ•°æ®
      if: steps.scan.outputs.needs_update == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        echo "ðŸ“Š ç”Ÿæˆæœ€æ–°å›¾ç‰‡å…ƒæ•°æ®..."
        npm run gallery:metadata
        
        # éªŒè¯å…ƒæ•°æ®å®Œæ•´æ€§
        METADATA_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('public/gallery-metadata.json', 'utf8')).count)")
        ACTUAL_COUNT=${{ steps.scan.outputs.image_count }}
        
        if [ "$METADATA_COUNT" != "$ACTUAL_COUNT" ]; then
          echo "âŒ å…ƒæ•°æ®ç”Ÿæˆå¤±è´¥: æœŸæœ› $ACTUAL_COUNT, å®žé™… $METADATA_COUNT"
          exit 1
        fi
        
        echo "âœ… å…ƒæ•°æ®éªŒè¯é€šè¿‡: $METADATA_COUNT å¼ å›¾ç‰‡"
    
    - name: ðŸ“ æ™ºèƒ½æäº¤æ›´æ”¹
      if: steps.scan.outputs.needs_update == 'true' || github.event.inputs.force_rebuild == 'true'
      run: |
        # é…ç½® Git
        git config --local user.email "action@github.com"
        git config --local user.name "ðŸ¤– Smart Gallery Bot"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --quiet; then
          echo "â„¹ï¸ æ— æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        # æ·»åŠ æ›´æ”¹
        git add public/gallery-metadata.json
        
        # ç”Ÿæˆæ™ºèƒ½æäº¤ä¿¡æ¯
        CHANGE_TYPE=""
        COUNT_CHANGE=${{ steps.scan.outputs.count_change }}
        
        if [ "$COUNT_CHANGE" -gt 0 ]; then
          CHANGE_TYPE="æ–°å¢ž $COUNT_CHANGE å¼ å›¾ç‰‡"
        elif [ "$COUNT_CHANGE" -lt 0 ]; then
          CHANGE_TYPE="åˆ é™¤ $((0 - COUNT_CHANGE)) å¼ å›¾ç‰‡"
        else
          CHANGE_TYPE="æ›´æ–°å…ƒæ•°æ®"
        fi
        
        COMMIT_MSG="ðŸ¤– è‡ªåŠ¨æ›´æ–°å›¾ç‰‡åº“ (${{ steps.scan.outputs.image_count }} å¼ å›¾ç‰‡)

        ðŸ“¸ å˜æ›´ç±»åž‹: $CHANGE_TYPE
        ðŸ†• æœ€æ–°å›¾ç‰‡: ${{ steps.scan.outputs.latest_image }}
        ðŸ“Š æ–‡ä»¶å¤§å°: ${{ steps.scan.outputs.latest_size }} bytes
        ðŸ•’ å¤„ç†æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ðŸ”§ è§¦å‘æ–¹å¼: GitHub ç½‘é¡µä¸Šä¼ 
        
        âœ¨ è‡ªåŠ¨åŒ–å¤„ç†:
        - âœ… è‡ªåŠ¨æ‰«ææ–°å›¾ç‰‡
        - âœ… è‡ªåŠ¨ç”Ÿæˆå…ƒæ•°æ®  
        - âœ… è‡ªåŠ¨éƒ¨ç½²åˆ° GitHub Pages
        
        ðŸŒ è®¿é—®åœ°å€: https://xiangyingchang.github.io/picture-gallery/
        
        [ðŸ¤– ç”± Smart Gallery Bot è‡ªåŠ¨å¤„ç†]"
        
        git commit -m "$COMMIT_MSG"
        echo "âœ… æ›´æ”¹å·²æäº¤"
    
    - name: ðŸš€ æŽ¨é€æ›´æ”¹
      if: steps.scan.outputs.needs_update == 'true' || github.event.inputs.force_rebuild == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
    
    - name: ðŸ—ï¸ æž„å»ºé¡¹ç›®
      run: |
        echo "ðŸ—ï¸ æž„å»º React é¡¹ç›®..."
        npm run build
        
        # éªŒè¯æž„å»ºç»“æžœ
        if [ ! -d "dist" ]; then
          echo "âŒ æž„å»ºå¤±è´¥: dist ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… é¡¹ç›®æž„å»ºå®Œæˆ"
    
    - name: ðŸŒ é…ç½® GitHub Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
    
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
    
    - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: âœ… éƒ¨ç½²åŽéªŒè¯
      run: |
        echo "â³ ç­‰å¾… CDN ç¼“å­˜åˆ·æ–°..."
        sleep 60
        
        # éªŒè¯çº¿ä¸Šéƒ¨ç½²
        EXPECTED_COUNT=${{ steps.scan.outputs.image_count }}
        
        for i in {1..5}; do
          echo "ðŸ” ç¬¬ $i æ¬¡éªŒè¯..."
          ONLINE_COUNT=$(curl -s "https://xiangyingchang.github.io/picture-gallery/gallery-metadata.json?t=$(date +%s)" | node -e "
            let data = '';
            process.stdin.on('data', chunk => data += chunk);
            process.stdin.on('end', () => {
              try {
                const json = JSON.parse(data);
                console.log(json.count);
              } catch(e) {
                console.log('0');
              }
            });
          " 2>/dev/null || echo "0")
          
          if [ "$ONLINE_COUNT" = "$EXPECTED_COUNT" ]; then
            echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸ: $ONLINE_COUNT å¼ å›¾ç‰‡"
            break
          else
            echo "âš ï¸ éªŒè¯å¤±è´¥: æœŸæœ› $EXPECTED_COUNT, å®žé™… $ONLINE_COUNT"
            if [ $i -lt 5 ]; then
              echo "â³ ç­‰å¾… 30 ç§’åŽé‡è¯•..."
              sleep 30
            fi
          fi
        done
    
    - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## ðŸŽ‰ æ™ºèƒ½å›¾ç‰‡åº“è‡ªåŠ¨åŒæ­¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š åŒæ­¥ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **å›¾ç‰‡æ€»æ•°**: ${{ steps.scan.outputs.image_count }} å¼ " >> $GITHUB_STEP_SUMMARY
        echo "- **æ•°é‡å˜åŒ–**: ${{ steps.scan.outputs.count_change }} å¼ " >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€æ–°å›¾ç‰‡**: ${{ steps.scan.outputs.latest_image }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤„ç†çŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ è®¿é—®é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- **å›¾ç‰‡åº“**: https://xiangyingchang.github.io/picture-gallery/" >> $GITHUB_STEP_SUMMARY
        echo "- **å…ƒæ•°æ®**: https://xiangyingchang.github.io/picture-gallery/gallery-metadata.json" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ ä½¿ç”¨è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "1. åœ¨ GitHub ç½‘é¡µä¸Šä¼ å›¾ç‰‡åˆ° \`public/uploads/\` ç›®å½•" >> $GITHUB_STEP_SUMMARY
        echo "2. ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†æ–°å›¾ç‰‡" >> $GITHUB_STEP_SUMMARY
        echo "3. çº¦ 5-10 åˆ†é’ŸåŽå³å¯åœ¨ç½‘ç«™ä¸Šçœ‹åˆ°æ–°å›¾ç‰‡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ æ•…éšœæŽ’é™¤" >> $GITHUB_STEP_SUMMARY
        echo "å¦‚æžœå›¾ç‰‡æœªæ˜¾ç¤ºï¼Œå¯ä»¥æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµé‡æ–°å¤„ç†ã€‚" >> $GITHUB_STEP_SUMMARY