name: æ™ºèƒ½å›¾ç‰‡åº“åŒæ­¥

on:
  push:
    paths:
      - 'public/uploads/**'
  workflow_dispatch:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    - cron: '0 * * * *'

jobs:
  sync-gallery:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: æ£€æµ‹å›¾ç‰‡å˜åŒ–
      id: detect-changes
      run: |
        echo "ğŸ” æ£€æµ‹å›¾ç‰‡æ–‡ä»¶å˜åŒ–..."
        
        # ç»Ÿè®¡å½“å‰å›¾ç‰‡æ•°é‡
        CURRENT_COUNT=$(find public/uploads -maxdepth 1 -name "*.jpg" -o -name "*.JPG" -o -name "*.png" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.webp" | wc -l)
        echo "å½“å‰å›¾ç‰‡æ•°é‡: $CURRENT_COUNT"
        
        # ä»å…ƒæ•°æ®æ–‡ä»¶è·å–è®°å½•çš„æ•°é‡
        if [ -f "public/gallery-metadata.json" ]; then
          RECORDED_COUNT=$(jq -r '.count // 0' public/gallery-metadata.json)
          echo "è®°å½•çš„å›¾ç‰‡æ•°é‡: $RECORDED_COUNT"
        else
          RECORDED_COUNT=0
          echo "å…ƒæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè®¾ç½®è®°å½•æ•°é‡ä¸º 0"
        fi
        
        echo "current_count=$CURRENT_COUNT" >> $GITHUB_OUTPUT
        echo "recorded_count=$RECORDED_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$CURRENT_COUNT" != "$RECORDED_COUNT" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°å›¾ç‰‡æ•°é‡å˜åŒ–ï¼Œéœ€è¦æ›´æ–°å…ƒæ•°æ®"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ å›¾ç‰‡æ•°é‡æ— å˜åŒ–"
        fi

    - name: ç”Ÿæˆå›¾ç‰‡å…ƒæ•°æ®
      if: steps.detect-changes.outputs.needs_update == 'true'
      run: |
        echo "ğŸ”„ é‡æ–°ç”Ÿæˆå›¾ç‰‡å…ƒæ•°æ®..."
        
        node -e "
        const fs = require('fs');
        const path = require('path');
        const crypto = require('crypto');
        
        const uploadsDir = 'public/uploads';
        const files = fs.readdirSync(uploadsDir);
        const imageFiles = [];
        
        console.log('ğŸ“‹ æ‰«æå›¾ç‰‡æ–‡ä»¶...');
        files.forEach(file => {
          if (file !== '.DS_Store') {
            const ext = path.extname(file).toLowerCase();
            if (['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(ext)) {
              imageFiles.push(file);
              console.log('  âœ“', file);
            }
          }
        });
        
        console.log('ğŸ“¸ æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶:', imageFiles.length, 'å¼ ');
        
        const images = imageFiles.map(filename => {
          const filePath = path.join(uploadsDir, filename);
          const stat = fs.statSync(filePath);
          const hash = crypto.createHash('md5').update(fs.readFileSync(filePath)).digest('hex');
          
          return {
            id: 'img_' + hash.substring(0, 8),
            filename: filename,
            path: 'uploads/' + filename,
            src: 'uploads/' + filename,
            title: path.basename(filename, path.extname(filename)),
            size: stat.size,
            created: stat.birthtime.toISOString(),
            modified: stat.mtime.toISOString(),
            hash: hash
          };
        }).sort((a, b) => new Date(b.created) - new Date(a.created));
        
        const metadata = {
          generated: new Date().toISOString(),
          count: images.length,
          version: Date.now(),
          images: images,
          migrated: true,
          migrationDate: new Date().toISOString(),
          autoGenerated: true,
          source: 'github-actions'
        };
        
        fs.writeFileSync('public/gallery-metadata.json', JSON.stringify(metadata, null, 2), 'utf8');
        
        console.log('âœ… å…ƒæ•°æ®ç”Ÿæˆå®Œæˆ!');
        console.log('ğŸ“Š å›¾ç‰‡æ€»æ•°:', metadata.count);
        console.log('ğŸ“¸ æœ€æ–°å›¾ç‰‡:', images[0]?.filename || 'æ— ');
        "

    - name: æäº¤æ›´æ–°
      if: steps.detect-changes.outputs.needs_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        CURRENT_COUNT="${{ steps.detect-changes.outputs.current_count }}"
        RECORDED_COUNT="${{ steps.detect-changes.outputs.recorded_count }}"
        
        if [ "$CURRENT_COUNT" -gt "$RECORDED_COUNT" ]; then
          CHANGE_TYPE="æ–°å¢"
          DIFF=$((CURRENT_COUNT - RECORDED_COUNT))
        else
          CHANGE_TYPE="åˆ é™¤"
          DIFF=$((RECORDED_COUNT - CURRENT_COUNT))
        fi
        
        git add public/gallery-metadata.json
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å›¾ç‰‡åº“ (${CHANGE_TYPE} ${DIFF} å¼ ï¼Œæ€»è®¡ ${CURRENT_COUNT} å¼ å›¾ç‰‡)" || exit 0
        git push