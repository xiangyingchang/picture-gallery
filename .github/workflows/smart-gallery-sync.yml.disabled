name: 智能图片库同步

on:
  push:
    paths:
      - 'public/uploads/**'
  workflow_dispatch:
  schedule:
    # 每小时检查一次
    - cron: '0 * * * *'

jobs:
  sync-gallery:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 检测图片变化
      id: detect-changes
      run: |
        echo "🔍 检测图片文件变化..."
        
        # 统计当前图片数量
        CURRENT_COUNT=$(find public/uploads -maxdepth 1 -name "*.jpg" -o -name "*.JPG" -o -name "*.png" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.webp" | wc -l)
        echo "当前图片数量: $CURRENT_COUNT"
        
        # 从元数据文件获取记录的数量
        if [ -f "public/gallery-metadata.json" ]; then
          RECORDED_COUNT=$(jq -r '.count // 0' public/gallery-metadata.json)
          echo "记录的图片数量: $RECORDED_COUNT"
        else
          RECORDED_COUNT=0
          echo "元数据文件不存在，设置记录数量为 0"
        fi
        
        echo "current_count=$CURRENT_COUNT" >> $GITHUB_OUTPUT
        echo "recorded_count=$RECORDED_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$CURRENT_COUNT" != "$RECORDED_COUNT" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "✅ 检测到图片数量变化，需要更新元数据"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "ℹ️ 图片数量无变化"
        fi

    - name: 生成图片元数据
      if: steps.detect-changes.outputs.needs_update == 'true'
      run: |
        echo "🔄 重新生成图片元数据..."
        
        node -e "
        const fs = require('fs');
        const path = require('path');
        const crypto = require('crypto');
        
        const uploadsDir = 'public/uploads';
        const files = fs.readdirSync(uploadsDir);
        const imageFiles = [];
        
        console.log('📋 扫描图片文件...');
        files.forEach(file => {
          if (file !== '.DS_Store') {
            const ext = path.extname(file).toLowerCase();
            if (['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(ext)) {
              imageFiles.push(file);
              console.log('  ✓', file);
            }
          }
        });
        
        console.log('📸 找到图片文件:', imageFiles.length, '张');
        
        const images = imageFiles.map(filename => {
          const filePath = path.join(uploadsDir, filename);
          const stat = fs.statSync(filePath);
          const hash = crypto.createHash('md5').update(fs.readFileSync(filePath)).digest('hex');
          
          return {
            id: 'img_' + hash.substring(0, 8),
            filename: filename,
            path: 'uploads/' + filename,
            src: 'uploads/' + filename,
            title: path.basename(filename, path.extname(filename)),
            size: stat.size,
            created: stat.birthtime.toISOString(),
            modified: stat.mtime.toISOString(),
            hash: hash
          };
        }).sort((a, b) => new Date(b.created) - new Date(a.created));
        
        const metadata = {
          generated: new Date().toISOString(),
          count: images.length,
          version: Date.now(),
          images: images,
          migrated: true,
          migrationDate: new Date().toISOString(),
          autoGenerated: true,
          source: 'github-actions'
        };
        
        fs.writeFileSync('public/gallery-metadata.json', JSON.stringify(metadata, null, 2), 'utf8');
        
        console.log('✅ 元数据生成完成!');
        console.log('📊 图片总数:', metadata.count);
        console.log('📸 最新图片:', images[0]?.filename || '无');
        "

    - name: 提交更新
      if: steps.detect-changes.outputs.needs_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        CURRENT_COUNT="${{ steps.detect-changes.outputs.current_count }}"
        RECORDED_COUNT="${{ steps.detect-changes.outputs.recorded_count }}"
        
        if [ "$CURRENT_COUNT" -gt "$RECORDED_COUNT" ]; then
          CHANGE_TYPE="新增"
          DIFF=$((CURRENT_COUNT - RECORDED_COUNT))
        else
          CHANGE_TYPE="删除"
          DIFF=$((RECORDED_COUNT - CURRENT_COUNT))
        fi
        
        git add public/gallery-metadata.json
        git commit -m "🤖 自动更新图片库 (${CHANGE_TYPE} ${DIFF} 张，总计 ${CURRENT_COUNT} 张图片)" || exit 0
        git push