name: Smart Gallery Auto Update

on:
  # å½“æœ‰æ–‡ä»¶æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'public/uploads/**'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ–°å›¾ç‰‡ï¼‰
  schedule:
    - cron: '0 * * * *'

# æƒé™è®¾ç½®
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  smart-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install automation dependencies
      run: npm install chokidar sharp --save-dev
    
    - name: Scan for new images
      id: scan_images
      run: |
        echo "ğŸ” æ‰«æå›¾ç‰‡ç›®å½•..."
        
        # åˆ›å»ºå›¾ç‰‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p public/uploads/2025/08
        
        # æ‰«ææ‰€æœ‰æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
        IMAGES=$(find public/uploads -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) 2>/dev/null || true)
        IMAGE_COUNT=$(echo "$IMAGES" | grep -c . || echo "0")
        
        echo "å‘ç° $IMAGE_COUNT å¼ å›¾ç‰‡"
        echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
        
        if [ $IMAGE_COUNT -gt 0 ]; then
          echo "has_images=true" >> $GITHUB_OUTPUT
          
          # è·å–æœ€æ–°çš„å›¾ç‰‡ä¿¡æ¯
          LATEST_IMAGE=$(echo "$IMAGES" | head -1)
          if [ -n "$LATEST_IMAGE" ]; then
            LATEST_NAME=$(basename "$LATEST_IMAGE")
            LATEST_SIZE=$(stat -f%z "$LATEST_IMAGE" 2>/dev/null || stat -c%s "$LATEST_IMAGE" 2>/dev/null || echo "0")
            echo "latest_image=$LATEST_NAME" >> $GITHUB_OUTPUT
            echo "latest_size=$LATEST_SIZE" >> $GITHUB_OUTPUT
          fi
        else
          echo "has_images=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Optimize images (optional)
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "ğŸ–¼ï¸ ä¼˜åŒ–å›¾ç‰‡..."
        
        # åˆ›å»ºå›¾ç‰‡ä¼˜åŒ–è„šæœ¬
        cat > optimize-images.js << 'EOF'
        const sharp = require('sharp');
        const fs = require('fs');
        const path = require('path');
        
        async function optimizeImages() {
          const uploadsDir = 'public/uploads';
          
          function findImages(dir) {
            const files = [];
            const items = fs.readdirSync(dir, { withFileTypes: true });
            
            for (const item of items) {
              const fullPath = path.join(dir, item.name);
              if (item.isDirectory()) {
                files.push(...findImages(fullPath));
              } else if (/\.(jpg|jpeg|png)$/i.test(item.name)) {
                files.push(fullPath);
              }
            }
            return files;
          }
          
          const imageFiles = findImages(uploadsDir);
          console.log(`æ‰¾åˆ° ${imageFiles.length} å¼ éœ€è¦ä¼˜åŒ–çš„å›¾ç‰‡`);
          
          for (const imagePath of imageFiles) {
            try {
              const stats = fs.statSync(imagePath);
              // åªä¼˜åŒ–å¤§äº 500KB çš„å›¾ç‰‡
              if (stats.size > 500 * 1024) {
                console.log(`ä¼˜åŒ–å›¾ç‰‡: ${imagePath} (${(stats.size / 1024).toFixed(2)} KB)`);
                
                await sharp(imagePath)
                  .resize(1920, 1920, { 
                    fit: 'inside', 
                    withoutEnlargement: true 
                  })
                  .jpeg({ 
                    quality: 85, 
                    progressive: true 
                  })
                  .toFile(imagePath + '.optimized');
                
                // æ›¿æ¢åŸæ–‡ä»¶
                fs.renameSync(imagePath + '.optimized', imagePath);
                
                const newStats = fs.statSync(imagePath);
                console.log(`ä¼˜åŒ–å®Œæˆ: ${(newStats.size / 1024).toFixed(2)} KB`);
              }
            } catch (error) {
              console.log(`ä¼˜åŒ–å¤±è´¥ ${imagePath}:`, error.message);
            }
          }
        }
        
        optimizeImages().catch(console.error);
        EOF
        
        # è¿è¡Œå›¾ç‰‡ä¼˜åŒ–ï¼ˆå¦‚æœ sharp å¯ç”¨ï¼‰
        node optimize-images.js || echo "å›¾ç‰‡ä¼˜åŒ–è·³è¿‡"
    
    - name: Generate image metadata
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "ğŸ“Š ç”Ÿæˆå›¾ç‰‡å…ƒæ•°æ®..."
        
        # åˆ›å»ºå…ƒæ•°æ®ç”Ÿæˆè„šæœ¬
        cat > generate-metadata.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const crypto = require('crypto');
        
        function generateMetadata() {
          const uploadsDir = 'public/uploads';
          const metadataFile = 'public/gallery-metadata.json';
          
          function findImages(dir) {
            const files = [];
            const items = fs.readdirSync(dir, { withFileTypes: true });
            
            for (const item of items) {
              const fullPath = path.join(dir, item.name);
              if (item.isDirectory()) {
                files.push(...findImages(fullPath));
              } else if (/\.(jpg|jpeg|png|webp|gif)$/i.test(item.name)) {
                files.push(fullPath);
              }
            }
            return files;
          }
          
          const imageFiles = findImages(uploadsDir);
          const metadata = {
            generated: new Date().toISOString(),
            count: imageFiles.length,
            images: []
          };
          
          for (const imagePath of imageFiles) {
            try {
              const stats = fs.statSync(imagePath);
              const relativePath = imagePath.replace('public/', '');
              const filename = path.basename(imagePath);
              const hash = crypto.createHash('md5').update(fs.readFileSync(imagePath)).digest('hex');
              
              metadata.images.push({
                id: hash.substring(0, 8),
                filename: filename,
                path: relativePath,
                size: stats.size,
                created: stats.birthtime.toISOString(),
                modified: stats.mtime.toISOString(),
                hash: hash
              });
            } catch (error) {
              console.log(`å¤„ç†æ–‡ä»¶å¤±è´¥ ${imagePath}:`, error.message);
            }
          }
          
          // æŒ‰ä¿®æ”¹æ—¶é—´å€’åºæ’åˆ—
          metadata.images.sort((a, b) => new Date(b.modified) - new Date(a.modified));
          
          fs.writeFileSync(metadataFile, JSON.stringify(metadata, null, 2));
          console.log(`ç”Ÿæˆå…ƒæ•°æ®æ–‡ä»¶: ${metadataFile}`);
          console.log(`åŒ…å« ${metadata.images.length} å¼ å›¾ç‰‡çš„ä¿¡æ¯`);
        }
        
        generateMetadata();
        EOF
        
        node generate-metadata.js
    
    - name: Update gallery store
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "ğŸ”„ æ›´æ–°å›¾ç‰‡åº“ä»£ç ..."
        node scripts/update-gallery.js
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç æ›´æ”¹
        if git diff --quiet src/store/gallery-store.tsx; then
          echo "ä»£ç æ— éœ€æ›´æ–°"
          echo "code_updated=false" >> $GITHUB_ENV
        else
          echo "ä»£ç å·²æ›´æ–°"
          echo "code_updated=true" >> $GITHUB_ENV
        fi
    
    - name: Commit changes
      if: env.code_updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Smart Gallery Bot"
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # åˆ›å»ºæ™ºèƒ½æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ¤– è‡ªåŠ¨æ›´æ–°å›¾ç‰‡åº“ (${{ steps.scan_images.outputs.image_count }} å¼ å›¾ç‰‡)

        ğŸ“¸ æœ€æ–°å›¾ç‰‡: ${{ steps.scan_images.outputs.latest_image }}
        ğŸ“Š æ–‡ä»¶å¤§å°: ${{ steps.scan_images.outputs.latest_size }} bytes
        ğŸ•’ æ›´æ–°æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ğŸ”§ å¤„ç†æ–¹å¼: GitHub Actions è‡ªåŠ¨åŒ–
        
        âœ¨ åŠŸèƒ½æ›´æ–°:
        - è‡ªåŠ¨æ‰«æå¹¶è¯†åˆ«æ–°å›¾ç‰‡
        - è‡ªåŠ¨ä¼˜åŒ–å›¾ç‰‡è´¨é‡å’Œå¤§å°
        - è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡å…ƒæ•°æ®
        - è‡ªåŠ¨æ›´æ–°å‰ç«¯ä»£ç 
        - è‡ªåŠ¨éƒ¨ç½²åˆ° GitHub Pages
        
        [ğŸ¤– Smart Gallery Bot]"
        
        git commit -m "$COMMIT_MSG"
        echo "âœ… æ›´æ”¹å·²æäº¤"
    
    - name: Push changes
      if: env.code_updated == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
    
    - name: Build project
      run: |
        echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
        npm run build
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Generate deployment report
      run: |
        echo "## ğŸš€ æ™ºèƒ½å›¾ç‰‡åº“éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š éƒ¨ç½²ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **å›¾ç‰‡æ€»æ•°**: ${{ steps.scan_images.outputs.image_count }} å¼ " >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€æ–°å›¾ç‰‡**: ${{ steps.scan_images.outputs.latest_image }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ä»£ç æ›´æ–°**: ${{ env.code_updated == 'true' && 'âœ… å·²æ›´æ–°' || 'â­ï¸ æ— éœ€æ›´æ–°' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²çŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "- **ç½‘ç«™åœ°å€**: https://xiangyingchang.github.io/picture-gallery/" >> $GITHUB_STEP_SUMMARY
        echo "- **å…ƒæ•°æ®**: https://xiangyingchang.github.io/picture-gallery/gallery-metadata.json" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ ä¸‹æ¬¡ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
        echo "åªéœ€å°†å›¾ç‰‡æ–‡ä»¶æ·»åŠ åˆ° \`public/uploads/\` ç›®å½•å¹¶æ¨é€åˆ° GitHubï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ä¸€åˆ‡ï¼" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify completion (optional)
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "ğŸ‰ è‡ªåŠ¨åŒ–æµç¨‹å®Œæˆï¼"
        echo "ğŸ“¸ å¤„ç†äº† ${{ steps.scan_images.outputs.image_count }} å¼ å›¾ç‰‡"
        echo "ğŸŒ ç½‘ç«™å·²æ›´æ–°: https://xiangyingchang.github.io/picture-gallery/"