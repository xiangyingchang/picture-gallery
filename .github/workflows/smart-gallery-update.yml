name: Smart Gallery Auto Update

on:
  # å½“æœ‰æ–‡ä»¶æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'public/uploads/**'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ–°å›¾ç‰‡ï¼‰
  schedule:
    - cron: '0 * * * *'

# æƒé™è®¾ç½®
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  smart-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Scan for new images
      id: scan_images
      run: |
        echo "ğŸ” æ‰«æå›¾ç‰‡ç›®å½•..."
        
        # åˆ›å»ºå›¾ç‰‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p public/uploads
        
        # æ‰«ææ‰€æœ‰æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
        IMAGES=$(find public/uploads -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) 2>/dev/null || true)
        IMAGE_COUNT=$(echo "$IMAGES" | grep -c . || echo "0")
        
        echo "å‘ç° $IMAGE_COUNT å¼ å›¾ç‰‡"
        echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
        
        if [ $IMAGE_COUNT -gt 0 ]; then
          echo "has_images=true" >> $GITHUB_OUTPUT
          
          # è·å–æœ€æ–°çš„å›¾ç‰‡ä¿¡æ¯
          LATEST_IMAGE=$(echo "$IMAGES" | head -1)
          if [ -n "$LATEST_IMAGE" ]; then
            LATEST_NAME=$(basename "$LATEST_IMAGE")
            LATEST_SIZE=$(stat -f%z "$LATEST_IMAGE" 2>/dev/null || stat -c%s "$LATEST_IMAGE" 2>/dev/null || echo "0")
            echo "latest_image=$LATEST_NAME" >> $GITHUB_OUTPUT
            echo "latest_size=$LATEST_SIZE" >> $GITHUB_OUTPUT
          fi
        else
          echo "has_images=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate image metadata
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "ğŸ“Š ç”Ÿæˆå›¾ç‰‡å…ƒæ•°æ®..."
        npm run gallery:metadata
        
        # ä¸å†è¿è¡Œ update-gallery.jsï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨åŠ¨æ€åŠ è½½
        echo "âœ… å…ƒæ•°æ®ç”Ÿæˆå®Œæˆï¼Œè·³è¿‡ gallery-store.tsx æ›´æ–°"
    
    - name: Check for changes
      id: check_changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹
        if git diff --quiet; then
          echo "æ— æ–‡ä»¶æ›´æ”¹"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Smart Gallery Bot"
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # åˆ›å»ºæ™ºèƒ½æäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ¤– è‡ªåŠ¨æ›´æ–°å›¾ç‰‡åº“ (${{ steps.scan_images.outputs.image_count }} å¼ å›¾ç‰‡)

        ğŸ“¸ æœ€æ–°å›¾ç‰‡: ${{ steps.scan_images.outputs.latest_image }}
        ğŸ“Š æ–‡ä»¶å¤§å°: ${{ steps.scan_images.outputs.latest_size }} bytes
        ğŸ•’ æ›´æ–°æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ğŸ”§ å¤„ç†æ–¹å¼: GitHub Actions è‡ªåŠ¨åŒ–
        
        âœ¨ åŠŸèƒ½æ›´æ–°:
        - è‡ªåŠ¨æ‰«æå¹¶è¯†åˆ«æ–°å›¾ç‰‡
        - è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡å…ƒæ•°æ®
        - è‡ªåŠ¨éƒ¨ç½²åˆ° GitHub Pages
        
        [ğŸ¤– Smart Gallery Bot]"
        
        git commit -m "$COMMIT_MSG"
        echo "âœ… æ›´æ”¹å·²æäº¤"
    
    - name: Push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
    
    - name: Build project
      run: |
        echo "ğŸ—ï¸ æ„å»ºé¡¹ç›®..."
        npm run build
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Generate deployment report
      run: |
        echo "## ğŸš€ æ™ºèƒ½å›¾ç‰‡åº“éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š éƒ¨ç½²ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **å›¾ç‰‡æ€»æ•°**: ${{ steps.scan_images.outputs.image_count }} å¼ " >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€æ–°å›¾ç‰‡**: ${{ steps.scan_images.outputs.latest_image }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ–‡ä»¶æ›´æ”¹**: ${{ steps.check_changes.outputs.has_changes == 'true' && 'âœ… å·²æ›´æ–°' || 'â­ï¸ æ— éœ€æ›´æ–°' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²çŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "- **ç½‘ç«™åœ°å€**: https://xiangyingchang.github.io/picture-gallery/" >> $GITHUB_STEP_SUMMARY
        echo "- **å…ƒæ•°æ®**: https://xiangyingchang.github.io/picture-gallery/gallery-metadata.json" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ ä¸‹æ¬¡ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
        echo "åªéœ€å°†å›¾ç‰‡æ–‡ä»¶æ·»åŠ åˆ° \`public/uploads/\` ç›®å½•å¹¶æ¨é€åˆ° GitHubï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ä¸€åˆ‡ï¼" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify completion (optional)
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "ğŸ‰ è‡ªåŠ¨åŒ–æµç¨‹å®Œæˆï¼"
        echo "ğŸ“¸ å¤„ç†äº† ${{ steps.scan_images.outputs.image_count }} å¼ å›¾ç‰‡"
        echo "ğŸŒ ç½‘ç«™å·²æ›´æ–°: https://xiangyingchang.github.io/picture-gallery/"