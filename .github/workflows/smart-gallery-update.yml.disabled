name: Smart Gallery Auto Update

on:
  # 当有文件推送到 main 分支时触发
  push:
    branches: [ main ]
    paths:
      - 'public/uploads/**'
  
  # 允许手动触发
  workflow_dispatch:
  
  # 定时检查（可选，每小时检查一次是否有新图片）
  schedule:
    - cron: '0 * * * *'

# 权限设置
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  smart-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Scan for new images
      id: scan_images
      run: |
        echo "🔍 扫描图片目录..."
        
        # 创建图片目录（如果不存在）
        mkdir -p public/uploads
        
        # 扫描所有支持的图片格式
        IMAGES=$(find public/uploads -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) 2>/dev/null || true)
        IMAGE_COUNT=$(echo "$IMAGES" | grep -c . || echo "0")
        
        echo "发现 $IMAGE_COUNT 张图片"
        echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT
        
        if [ $IMAGE_COUNT -gt 0 ]; then
          echo "has_images=true" >> $GITHUB_OUTPUT
          
          # 获取最新的图片信息
          LATEST_IMAGE=$(echo "$IMAGES" | head -1)
          if [ -n "$LATEST_IMAGE" ]; then
            LATEST_NAME=$(basename "$LATEST_IMAGE")
            LATEST_SIZE=$(stat -f%z "$LATEST_IMAGE" 2>/dev/null || stat -c%s "$LATEST_IMAGE" 2>/dev/null || echo "0")
            echo "latest_image=$LATEST_NAME" >> $GITHUB_OUTPUT
            echo "latest_size=$LATEST_SIZE" >> $GITHUB_OUTPUT
          fi
        else
          echo "has_images=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate image metadata
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "📊 生成图片元数据..."
        npm run gallery:metadata
        
        # 不再运行 update-gallery.js，因为我们使用动态加载
        echo "✅ 元数据生成完成，跳过 gallery-store.tsx 更新"
    
    - name: Check for changes
      id: check_changes
      run: |
        # 检查是否有文件更改
        if git diff --quiet; then
          echo "无文件更改"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "检测到文件更改"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Smart Gallery Bot"
        
        # 添加所有更改
        git add .
        
        # 创建智能提交信息
        COMMIT_MSG="🤖 自动更新图片库 (${{ steps.scan_images.outputs.image_count }} 张图片)

        📸 最新图片: ${{ steps.scan_images.outputs.latest_image }}
        📊 文件大小: ${{ steps.scan_images.outputs.latest_size }} bytes
        🕒 更新时间: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        🔧 处理方式: GitHub Actions 自动化
        
        ✨ 功能更新:
        - 自动扫描并识别新图片
        - 自动生成图片元数据
        - 自动部署到 GitHub Pages
        
        [🤖 Smart Gallery Bot]"
        
        git commit -m "$COMMIT_MSG"
        echo "✅ 更改已提交"
    
    - name: Push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
    
    - name: Build project
      run: |
        echo "🏗️ 构建项目..."
        npm run build
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      with:
        enablement: true
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Generate deployment report
      run: |
        echo "## 🚀 智能图片库部署完成" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📊 部署统计" >> $GITHUB_STEP_SUMMARY
        echo "- **图片总数**: ${{ steps.scan_images.outputs.image_count }} 张" >> $GITHUB_STEP_SUMMARY
        echo "- **最新图片**: ${{ steps.scan_images.outputs.latest_image }}" >> $GITHUB_STEP_SUMMARY
        echo "- **文件更改**: ${{ steps.check_changes.outputs.has_changes == 'true' && '✅ 已更新' || '⏭️ 无需更新' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **部署状态**: ✅ 成功" >> $GITHUB_STEP_SUMMARY
        echo "- **部署时间**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🌐 访问链接" >> $GITHUB_STEP_SUMMARY
        echo "- **网站地址**: https://xiangyingchang.github.io/picture-gallery/" >> $GITHUB_STEP_SUMMARY
        echo "- **元数据**: https://xiangyingchang.github.io/picture-gallery/gallery-metadata.json" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🎯 下次使用" >> $GITHUB_STEP_SUMMARY
        echo "只需将图片文件添加到 \`public/uploads/\` 目录并推送到 GitHub，系统会自动处理一切！" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify completion (optional)
      if: steps.scan_images.outputs.has_images == 'true'
      run: |
        echo "🎉 自动化流程完成！"
        echo "📸 处理了 ${{ steps.scan_images.outputs.image_count }} 张图片"
        echo "🌐 网站已更新: https://xiangyingchang.github.io/picture-gallery/"